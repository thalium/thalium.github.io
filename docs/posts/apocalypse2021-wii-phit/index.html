<!DOCTYPE html>
<html lang="en-us">

<head>
<meta charset="utf-8" />
<meta name="author" content="Thalium Team" />
<meta name="description" content="Thalium blog." />
<meta name="keywords" content="blog, tech" />
<meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
<meta name="generator" content="Hugo 0.83.1" />

<link rel="canonical" href="https://thalium.github.io/blog/posts/apocalypse2021-wii-phit/">
<meta property="og:title" content="Cyber Apocalypse 2021 2/5 - Wii-Phit" />
<meta property="og:description" content="Wii-Phit was the only Hard crypto challenge designed by CryptoHack for the Cyber Apocalypse 2021 CTF (there were also 4 challenges categorized as Insane though).
There is already an excellent writeup by the challenge organizers:
one could recognize a well known equation related to the Erdős–Straus conjecture, some participants used Z3.
We took a different approach." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://thalium.github.io/blog/posts/apocalypse2021-wii-phit/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-04-28T12:00:01&#43;01:00" />
<meta property="article:modified_time" content="2021-04-28T12:00:01&#43;01:00" />


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Cyber Apocalypse 2021 2/5 - Wii-Phit"/>
<meta name="twitter:description" content="Wii-Phit was the only Hard crypto challenge designed by CryptoHack for the Cyber Apocalypse 2021 CTF (there were also 4 challenges categorized as Insane though).
There is already an excellent writeup by the challenge organizers:
one could recognize a well known equation related to the Erdős–Straus conjecture, some participants used Z3.
We took a different approach."/>


<meta itemprop="name" content="Cyber Apocalypse 2021 2/5 - Wii-Phit">
<meta itemprop="description" content="Wii-Phit was the only Hard crypto challenge designed by CryptoHack for the Cyber Apocalypse 2021 CTF (there were also 4 challenges categorized as Insane though).
There is already an excellent writeup by the challenge organizers:
one could recognize a well known equation related to the Erdős–Straus conjecture, some participants used Z3.
We took a different approach."><meta itemprop="datePublished" content="2021-04-28T12:00:01&#43;01:00" />
<meta itemprop="dateModified" content="2021-04-28T12:00:01&#43;01:00" />
<meta itemprop="wordCount" content="921">
<meta itemprop="keywords" content="CTF,Writeup,CyberApocalypse2021," />

<link rel="stylesheet" href="https://thalium.github.io/blog/css/layout.css" />


<link rel="stylesheet" href="https://thalium.github.io/blog/css/default-dark.css" />


<link rel="icon" href="https://thalium.github.io/blog/favicon.ico" />


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-141692648-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


<title>


     Cyber Apocalypse 2021 2/5 - Wii-Phit 

</title>



<script>
  MathJax = {
    tex: {
      inlineMath: [['∳', '∳']],   
      displayMath: [['∳∳','∳∳']],
      processEscapes: true,
    },
    svg: {
      fontCache: 'global'
    }
  };
</script>
<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
</script>

</head>


<body>
  <style>
  @font-face {
    font-family: 'days_one';
    src: url('/blog/days_one.ttf') format('truetype');
  }
  .siteTitle {
    margin-top: 24px;
  }
  .siteTitle img {
    display: inline-block;
    vertical-align: middle;
    margin-top: -24px;
    margin-right: -10px;
  }
  .siteTitle span {
    font-family: 'days_one', Fallback, sans-serif;
    color: white;
    font-size: 160%;
  }
  </style>
<div class="main">
<header>

<div class="header-bar">

  <nav>
    <div class="siteTitle">
      <a href="https://thalium.github.io/blog/">
        <img src="https://thalium.github.io/blog/shard_only_no_background.png" width=12%></img>
        <span>THALIUM</span>
      </a>
    </div> 

    
    
    <a class="nav-item" href="https://thalium.github.io/blog/posts/"><div class="nav-item-title">Posts</div></a>
    

  </nav>

  
<div class="social-links-header">

  
  <a href="mailto:thalium.team@gmail.com"><div class="social-link">Email</div></a>
  

  
  <a href="https://github.com/thalium" target="_blank"><div class="social-link">Github</div></a>
  

  

  
  <a href="https://twitter.com/thalium_team" target="_blank"><div class="social-link">Twitter</div></a>
  

  

</div>


</div>


</header>


<article class="post">
    <h1 class="title"> Cyber Apocalypse 2021 2/5 - Wii-Phit </h1>
    <div class="content"> <p><strong>Wii-Phit</strong> was the only <em>Hard</em> crypto challenge designed by <a href="https://cryptohack.org/">CryptoHack</a> for the <a href="https://www.hackthebox.eu/cyber-apocalypse-ctf-2021">Cyber Apocalypse 2021</a> CTF (there were also 4 challenges categorized as <em>Insane</em> though).</p>
<p>There is already an excellent <a href="https://blog.cryptohack.org/cyber-apocalypse-2021#wii-phit">writeup</a> by the challenge organizers:
one could recognize a well known equation related to the <a href="https://en.wikipedia.org/wiki/Erd%C5%91s%E2%80%93Straus_conjecture">Erdős–Straus conjecture</a>, some participants used <a href="https://github.com/Z3Prover/z3">Z3</a>.
We took a different approach.</p>
<p>The main difficulty is to find an integer solution to</p>
<p>∳∳
w(xz + yz - xy) == 4xyz
∳∳</p>
<p>where ∳w∳ is a given 512 bits integer.</p>
<p>More specifically, the flag is encrypted with RSA, the prime factors ∳p∳ and ∳q∳ are obviously secret, but we know that they pass the following assert:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">w <span style="color:#f92672">=</span> <span style="color:#ae81ff">25965460884749769384351428855708318685345170011800821829011862918688758545847199832834284337871947234627057905530743956554688825819477516944610078633662855</span>
x <span style="color:#f92672">=</span> p <span style="color:#f92672">+</span> <span style="color:#ae81ff">1328</span>
y <span style="color:#f92672">=</span> p <span style="color:#f92672">+</span> <span style="color:#ae81ff">1329</span>
z <span style="color:#f92672">=</span> q <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>

<span style="color:#66d9ef">assert</span> w<span style="color:#f92672">*</span>(x<span style="color:#f92672">*</span>z <span style="color:#f92672">+</span> y<span style="color:#f92672">*</span>z <span style="color:#f92672">-</span> x<span style="color:#f92672">*</span>y) <span style="color:#f92672">==</span> <span style="color:#ae81ff">4</span><span style="color:#f92672">*</span>x<span style="color:#f92672">*</span>y<span style="color:#f92672">*</span>z
</code></pre></div><p>Before really starting we can observe that ∳y∳ is ∳x + 1∳ and thus ∳x∳ and ∳y∳ are coprime.
Moreover we know a few factors of ∳w∳ thanks to <a href="http://factordb.com/index.php?query=25965460884749769384351428855708318685345170011800821829011862918688758545847199832834284337871947234627057905530743956554688825819477516944610078633662855">factordb.com</a>.</p>
<p>If we rewrite the assert to put all the multiples of ∳z∳ on the same side we get:</p>
<p>∳∳
\begin{aligned}
w(xz + yz) - 4xyz &amp;= wxy\\<br>
(w(x + y) - 4xy)z &amp;= wxy
\end{aligned}
∳∳</p>
<p>Thus ∳wxy∳ is a multiple of ∳z∳, in other words: ∳z∳ divides ∳wxy∳.</p>
<p>Similarly ∳x∳ divides ∳wyz∳, and ∳y∳ divides ∳wxz∳.</p>
<p>But ∳x∳ and ∳y∳ are coprime, thus:</p>
<ul>
<li><em>∳x∳ divides ∳wyz∳</em> implies that ∳x∳ divides ∳wz∳</li>
<li>similarly ∳y∳ divides ∳wz∳</li>
</ul>
<p>Again, using the fact that ∳x∳ and ∳y∳ are coprime we can deduce that ∳xy∳ divides ∳wz∳, since they both divide ∳wz∳.</p>
<p>As a consequence, we know that there exist two integers ∳α∳ and ∳β∳ such that:</p>
<p>∳∳
\begin{aligned}
wxy = αz\\<br>
wz = βxy
\end{aligned}
∳∳</p>
<p>Taking the product leads to ∳w^2xyz = αβxyz∳ or ∳w^2 = αβ∳ after simplification.
We know some factors of ∳w^2∳, by distributing them over ∳α∳ and ∳β∳ we may find their values.</p>
<p>We now have a set of candidates for ∳α∳ and ∳β∳.
By using ∳wxy = αz∳ and ∳y = x + 1∳ we can rewrite our original assert as a degree 2 equation in ∳x∳:</p>
<p>∳∳
\begin{aligned}
w(xz + yz - xy) &amp;= 4xyz\\<br>
wxz + w(x+1)z - αz &amp;= 4x(x+1)z\\<br>
wx + w(x+1) - α &amp;= 4x(x+1)\\<br>
4x^2 + (4 - 2w)x + α - w &amp;= 0
\end{aligned}
∳∳</p>
<p>Now all we have to do is solve this equation for all the ∳α∳ we were able to build, looking for an integer solution.
That is what we did and it found a suitable solution for ∳α = 1∳.
It is then rather straightforward to get ∳p∳, ∳q∳, and the RSA private key (beware of the unusual ∳φ(N)∳), leading to the flag:</p>
<pre><code>CHTB{Erdos-Straus-Conjecture}
</code></pre><p>Our script can be found below.</p>
<p>This is how we solved the challenge, but we were curious about the <a href="https://en.wikipedia.org/wiki/Erd%C5%91s%E2%80%93Straus_conjecture">Erdős–Straus conjecture</a> and looked back at our equation with ∳α = 1∳.</p>
<p>We have the following discriminant:</p>
<p>∳∳
\begin{aligned}
Δ &amp;= (4 - 2w)^2 - 4\times{}4(1-w)\\<br>
Δ &amp;= 16 - 16w + 4w^2 - 16 + 16w\\<br>
Δ &amp;= (2w)^2
\end{aligned}
∳∳</p>
<p>Which gives the following positive solution:</p>
<p>∳∳
\begin{aligned}
x &amp;= (- (4 - 2w) + √Δ) / (2\times{}4)\\<br>
x &amp;= (w-1)/2
\end{aligned}
∳∳</p>
<p>Then ∳y = (w+1)/2∳ and ∳z = w(w-1)(w+1)/4∳.</p>
<p>We actually did not need to know any factor of ∳w∳, we just needed it to be positive and odd.
But knowing some factors and the fact that ∳y = x + 1∳ gently pushed us in the right direction to rediscover the decomposition mentioned in the wikipedia article on the <a href="https://en.wikipedia.org/wiki/Erd%C5%91s%E2%80%93Straus_conjecture#Negative-number_solutions">Erdős–Straus conjecture</a>.</p>
<p>Here is (a cleaned-up version of) the code we used to find ∳p∳ and ∳q∳ and get the flag:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> itertools <span style="color:#f92672">import</span> combinations
<span style="color:#f92672">from</span> math <span style="color:#f92672">import</span> isqrt, prod


<span style="color:#75715e"># Challenge Data</span>
cipher <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x12F47F77C4B5A72A0D14A066FEDC80BA6064058C900A798F1658DE60F13E1D8F21106654C4AAC740FD5E2D7CF62F0D3284C2686D2AAC261E35576DF989185FEE449C20EFA171FF3D168A04BCE84E51AF255383A59ED42583E93481CBFB24FDDDA16E0A767BFF622A4753E1A5DF248AF14C9AD50F842BE47EBB930604BECFD4AF04D21C0B2248A16CDEE16A04B4A12AC7E2161CB63E2D86999A1A8ED2A8FAEB4F4986C2A3FBD5916EFFB1D9F3F04E330FDD8179EA6952B14F758D385C4BC9C5AE30F516C17B23C7C6B9DBE40E16E90D8734BAEB69FED12149174B22ADD6B96750E4416CA7ADDF70BCEC9210B967991E487A4542899DDE3ABF3A91BBBAEFFAE67831C46C2238E6E5F4D8004543247FAE7FF25BBB01A1AB3196D8A9CFD693096AABEC46C2095F2A82A408F688BBEDDDC407B328D4EA5394348285F48AFEAAFACC333CFF3822E791B9940121B73F4E31C93C6B72BA3EDE7BBA87419B154DC6099EC95F56ED74FB5C55D9D8B3B8C0FC7DE99F344BEB118AC3D4333EB692710EAA7FD22</span>
exponent <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x10001</span>
w <span style="color:#f92672">=</span> <span style="color:#ae81ff">25965460884749769384351428855708318685345170011800821829011862918688758545847199832834284337871947234627057905530743956554688825819477516944610078633662855</span>

<span style="color:#75715e"># known factors of w*w</span>
FACTORS <span style="color:#f92672">=</span> [
    <span style="color:#ae81ff">3</span>,
    <span style="color:#ae81ff">3</span>,
    <span style="color:#ae81ff">5</span>,
    <span style="color:#ae81ff">7</span>,
    <span style="color:#ae81ff">13</span>,
    <span style="color:#ae81ff">29</span>,
    <span style="color:#ae81ff">434042467</span>,
    <span style="color:#ae81ff">2653449587</span>,
    <span style="color:#ae81ff">829389339613</span>,
    <span style="color:#ae81ff">83650191286538267</span>,
    <span style="color:#ae81ff">2736375417317167558343187941866480708142084464122192435130859730622053555029655238941106280888782037819</span>,
]
FACTORS <span style="color:#f92672">+=</span> FACTORS


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">decrypt_flag</span>(p, q):
    N <span style="color:#f92672">=</span> p <span style="color:#f92672">**</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> q
    phi <span style="color:#f92672">=</span> p <span style="color:#f92672">**</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> (p <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">*</span> (q <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>)
    d <span style="color:#f92672">=</span> pow(exponent, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, phi)
    m <span style="color:#f92672">=</span> pow(cipher, d, N)
    flag <span style="color:#f92672">=</span> m<span style="color:#f92672">.</span>to_bytes((m<span style="color:#f92672">.</span>bit_length() <span style="color:#f92672">+</span> <span style="color:#ae81ff">7</span>) <span style="color:#f92672">//</span> <span style="color:#ae81ff">8</span>, <span style="color:#e6db74">&#34;big&#34;</span>)

    <span style="color:#66d9ef">print</span>(f<span style="color:#e6db74">&#34;{flag=}&#34;</span>)


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">check_candidate</span>(alpha):
    <span style="color:#75715e"># we are trying to solve: 4*x² + (4 - 2*w)*x + alpha - w = 0</span>
    a <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>
    b <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> w
    c <span style="color:#f92672">=</span> alpha <span style="color:#f92672">-</span> w
    delta <span style="color:#f92672">=</span> b <span style="color:#f92672">**</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">4</span> <span style="color:#f92672">*</span> a <span style="color:#f92672">*</span> c

    <span style="color:#66d9ef">if</span> delta <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>:
        <span style="color:#66d9ef">return</span>

    <span style="color:#75715e"># sqrt may fail if delta is too big, we use isqrt instead</span>
    <span style="color:#75715e"># but we have to check if we got the actual square root</span>
    sqrt_delta <span style="color:#f92672">=</span> isqrt(delta)
    <span style="color:#66d9ef">if</span> sqrt_delta <span style="color:#f92672">**</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">!=</span> delta:
        <span style="color:#66d9ef">return</span>

    <span style="color:#75715e"># solutions are (-b +/- sqrt_delta) / (2*a)</span>
    <span style="color:#75715e"># division may fail if operands are too big</span>
    <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> [<span style="color:#f92672">-</span>b <span style="color:#f92672">-</span> sqrt_delta, <span style="color:#f92672">-</span>b <span style="color:#f92672">+</span> sqrt_delta]:
        <span style="color:#66d9ef">if</span> x <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">or</span> x <span style="color:#f92672">%</span> (<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> a) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>:
            <span style="color:#75715e"># x is not a positive integer</span>
            <span style="color:#66d9ef">continue</span>

        x <span style="color:#f92672">=</span> x <span style="color:#f92672">//</span> (<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> a)
        y <span style="color:#f92672">=</span> x <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
        <span style="color:#66d9ef">if</span> w <span style="color:#f92672">*</span> x <span style="color:#f92672">*</span> y <span style="color:#f92672">%</span> alpha <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>:
            <span style="color:#75715e"># z = (w * x * y) / alpha is not an integer</span>
            <span style="color:#66d9ef">continue</span>

        z <span style="color:#f92672">=</span> (w <span style="color:#f92672">*</span> x <span style="color:#f92672">*</span> y) <span style="color:#f92672">//</span> alpha

        p <span style="color:#f92672">=</span> x <span style="color:#f92672">-</span> <span style="color:#ae81ff">1328</span>
        q <span style="color:#f92672">=</span> z <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>

        decrypt_flag(p, q)


<span style="color:#75715e"># number of factors considered to build alpha</span>
nbr_factors <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>

<span style="color:#66d9ef">while</span> nbr_factors <span style="color:#f92672">&lt;=</span> len(FACTORS):
    worklist <span style="color:#f92672">=</span> combinations(FACTORS, nbr_factors)

    <span style="color:#66d9ef">for</span> alpha_factors <span style="color:#f92672">in</span> worklist:
        check_candidate(prod(alpha_factors))

    nbr_factors <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</code></pre></div> </div>
    <footer class="post-footer">

  <div class="post-footer-data">
            
<div class="tags">
  
    
      <div class="tag">
        <a href="https://thalium.github.io/blog/tags/ctf">#CTF</a>
      </div>
    
      <div class="tag">
        <a href="https://thalium.github.io/blog/tags/writeup">#Writeup</a>
      </div>
    
      <div class="tag">
        <a href="https://thalium.github.io/blog/tags/cyberapocalypse2021">#CyberApocalypse2021</a>
      </div>
    
  
</div>

    <span class="date">
      2021-04-28
      <span class="author">
        by 
          Colas Le Guernic
          
        </span>
    </span>
    
  </div>
</footer>



</article>

  <footer>

  <div class="social-links-footer">

  
  <a href="mailto:thalium.team@gmail.com"><div class="social-link">Email</div></a>
  

  
  <a href="https://github.com/thalium" target="_blank"><div class="social-link">GitHub</div></a>
  

  

  
  <a href="https://twitter.com/thalium_team" target="_blank"><div class="social-link">Twitter</div></a>
  

  

  <div class="social-link">
  <a href="https://thalium.github.io/blog/index.xml" target="_blank">RSS</a>
  </div>

</div>


  <div class="copyright"> Copyright (c) 2020, all rights reserved. </div>

  <div class="poweredby">
    Powered by <a href="https://gohugo.io/">Hugo</a>.
  </div>

  </footer>

</div> 

</body>
</html>

